<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Management - Comfort Stays PG</title>
    <link rel="stylesheet" href="documents-styles.css">
    <link rel="icon" type="image/png" href="pg-logo.png">
</head>
<body>
    <div class="manage-container">
        <header class="manage-header">
            <div class="header-content">
                <div class="logo-section">
                    <img src="pg-logo.png" alt="Comfort Stays PG Logo" class="logo-img">
                    <h1>Document Management</h1>
                </div>
                <div class="header-actions">
                    <button onclick="goBack()" class="btn-secondary">‚Üê Back to Website</button>
                    <button onclick="window.location.href='manage.html'" class="btn-primary">üè† Bed Management</button>
                    <button onclick="window.location.href='transactions.html'" class="btn-primary">üí≥ Transactions</button>
                    <button onclick="signOutUser()" class="btn-danger">üö™ Sign Out</button>
                </div>
            </div>
        </header>

        <main class="manage-main">
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="loading-indicator">
                <div class="loading-spinner"></div>
                <p>Checking authentication...</p>
            </div>
            
            <!-- Document Management Section -->
            <div class="document-management-section" id="documentManagementSection" style="display: none;">
                <div class="document-header">
                    <h2>üìÑ Guest Document Management</h2>
                    <div class="document-controls">
                        <div class="search-box">
                            <input type="text" id="documentSearch" placeholder="Search by guest email or document type..." onkeyup="filterDocuments()">
                            <button onclick="refreshDocuments()" class="btn-primary">üîÑ Refresh</button>
                        </div>
                        <div class="filter-controls">
                            <select id="documentTypeFilter" onchange="filterDocuments()">
                                <option value="">All Document Types</option>
                                <option value="id_proof">ID Proof</option>
                                <option value="college_id">College ID</option>
                                <option value="address_proof">Address Proof</option>
                                <option value="emergency_contact">Emergency Contact</option>
                                <option value="medical_certificate">Medical Certificate</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Occupant Info Section (Outside Form) -->
                <div class="occupant-info-section" id="occupantInfoSection" style="display: none;">
                    <div class="occupant-info-card">
                        <div class="occupant-info-header">
                            <h4>üë§ Occupant Information</h4>
                        </div>
                        <div class="occupant-info-content">
                            <div class="occupant-detail">
                                <span class="detail-label">Name:</span>
                                <span class="detail-value" id="occupantName">-</span>
                            </div>
                            <div class="occupant-detail">
                                <span class="detail-label">Phone:</span>
                                <span class="detail-value" id="occupantPhoneDisplay">-</span>
                            </div>
                            <div class="occupant-detail">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value" id="occupantEmailDisplay">-</span>
                            </div>
                            <div class="occupant-detail">
                                <span class="detail-label">Bed:</span>
                                <span class="detail-value" id="occupantBedDisplay">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Add Document Button -->
                <div class="add-document-section">
                    <button onclick="toggleUploadForm()" class="btn-primary" id="toggleUploadBtn">+ Add Document</button>
                </div>
                
                <!-- Document Upload Section -->
                <div class="document-upload-section" style="display: none;">
                    <div class="upload-header">
                        <h3>üì§ Upload New Document</h3>
                    </div>
                    
                    <div class="upload-form" id="uploadForm" style="display: none;">
                        <div class="upload-form-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="guestEmail">Guest Email</label>
                                    <input type="email" id="guestEmail" placeholder="Enter guest email address (optional)">
                                </div>
                                <div class="form-group">
                                    <label for="guestPhone">Guest Mobile Number *</label>
                                    <input type="tel" id="guestPhone" placeholder="Enter mobile number (e.g., 9876543210 or +919876543210)" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="documentType">Document Type *</label>
                                    <select id="documentType" required>
                                        <option value="">Select document type</option>
                                        <option value="id_proof">ID Proof (Aadhaar/PAN)</option>
                                        <option value="college_id">College ID</option>
                                        <option value="address_proof">Address Proof</option>
                                        <option value="emergency_contact">Emergency Contact</option>
                                        <option value="medical_certificate">Medical Certificate</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="documentName">Document Name</label>
                                    <input type="text" id="documentName" placeholder="e.g., Aadhaar Card - Front">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="documentFile">Select File *</label>
                                    <input type="file" id="documentFile" accept="image/*,.pdf" required onchange="previewFile()">
                                    <small class="file-info">Supported formats: JPG, PNG, PDF (Max 10MB)</small>
                                </div>
                            </div>
                            
                            <!-- File Preview Section -->
                            <div class="file-preview-section" id="filePreviewSection" style="display: none;">
                                <h4>üìÑ File Preview</h4>
                                <div class="file-preview-container" id="filePreviewContainer">
                                    <!-- Preview content will be inserted here -->
                                </div>
                                
                                <!-- Crop Controls (only for images) -->
                                <div class="crop-controls" id="cropControls" style="display: none;">
                                    <div class="crop-header">
                                        <h5>‚úÇÔ∏è Crop Image</h5>
                                        <div class="crop-buttons">
                                            <button type="button" onclick="startCrop()" class="btn-crop" id="startCropBtn">Start Crop</button>
                                            <button type="button" onclick="applyCrop()" class="btn-crop btn-crop-primary" id="applyCropBtn" style="display: none;">Apply Crop</button>
                                            <button type="button" onclick="cancelCrop()" class="btn-crop btn-crop-secondary" id="cancelCropBtn" style="display: none;">Cancel</button>
                                        </div>
                                    </div>
                                    <div class="crop-instructions">
                                        <small>Click and drag to select the area you want to keep. You can adjust the selection by dragging the corners.</small>
                                    </div>
                                </div>
                                
                                <div class="file-info-preview" id="fileInfoPreview">
                                    <!-- File info will be displayed here -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="documentNotes">Notes (Optional)</label>
                                <textarea id="documentNotes" placeholder="Any additional notes about this document..." rows="3"></textarea>
                            </div>
                            
                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-text" id="progressText">Uploading...</div>
                            </div>
                            
                            <div class="upload-actions">
                                <button type="button" onclick="uploadDocument()" class="btn-primary" id="uploadBtn">
                                    üì§ Upload Document
                                </button>
                                <button type="button" onclick="resetUploadForm()" class="btn-secondary">
                                    üîÑ Reset Form
                                </button>
                                <button type="button" onclick="toggleUploadForm()" class="btn-secondary">
                                    ‚ùå Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="document-stats">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <h3>Total Documents</h3>
                            <div class="stat-number" id="totalDocuments">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3>Guests with Documents</h3>
                            <div class="stat-number" id="guestsWithDocuments">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÅ</div>
                        <div class="stat-content">
                            <h3>Storage Used</h3>
                            <div class="stat-number" id="storageUsed">0 MB</div>
                        </div>
                    </div>
                </div>
                
                <div class="documents-container">
                    <div class="documents-list" id="documentsList">
                        <!-- Documents will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Shared Authentication Module -->
    <script src="shared-auth.js"></script>
    
    <script>
        // Document Management Variables
        let allDocuments = [];
        let filteredDocuments = [];

        // Initialize the page
        document.addEventListener("DOMContentLoaded", async function() {
            // Use shared authentication
            const authSuccess = await window.initializeProtectedPage();
            
            if (authSuccess) {
                // Hide loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Check for URL parameters to pre-fill fields
                const urlParams = new URLSearchParams(window.location.search);
                const emailParam = urlParams.get('email');
                const phoneParam = urlParams.get('phone');
                
                if (emailParam) {
                    const guestEmailField = document.getElementById('guestEmail');
                    if (guestEmailField) {
                        guestEmailField.value = decodeURIComponent(emailParam);
                    }
                }
                
                if (phoneParam) {
                    const guestPhoneField = document.getElementById('guestPhone');
                    if (guestPhoneField) {
                        guestPhoneField.value = decodeURIComponent(phoneParam);
                    }
                }
                
                // Ensure form is hidden by default
                const uploadSection = document.querySelector('.document-upload-section');
                const uploadForm = document.getElementById('uploadForm');
                const toggleBtn = document.getElementById('toggleUploadBtn');
                
                // Force hide the form initially
                uploadSection.style.display = 'none';
                uploadForm.style.display = 'none';
                toggleBtn.textContent = '+ Add Document';
                toggleBtn.classList.add('btn-primary');
                toggleBtn.classList.remove('btn-secondary');
                
                // Lookup occupant information if phone number is provided (but don't auto-show form)
                if (phoneParam) {
                    await lookupOccupantInfo(phoneParam);
                    // Show occupant info section since it's now outside the form
                    const occupantInfoSection = document.getElementById('occupantInfoSection');
                    if (occupantInfoSection) {
                        occupantInfoSection.style.display = 'block';
                    }
                }
                
                // Show document management section
                document.getElementById('documentManagementSection').style.display = 'block';
                
                // Load documents
                await loadAllDocuments();
                
                console.log('Document management page initialized successfully');
            } else {
                console.error('Authentication failed');
            }
        });

        async function loadAllDocuments() {
            try {
                // Wait for Firebase to be fully initialized
                let retries = 0;
                while (!window.getAllGuestDocuments && retries < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retries++;
                }
                
                if (!window.getAllGuestDocuments) {
                    throw new Error('Firebase functions not available after 10 retries');
                }
                
                allDocuments = await window.getAllGuestDocuments();
                filteredDocuments = [...allDocuments];
                
                updateDocumentStats();
                renderDocuments();
                
            } catch (error) {
                console.error('Error loading documents:', error);
                showDocumentError('Failed to load documents. Please try again.');
            }
        }

        function updateDocumentStats() {
            const totalDocuments = allDocuments.length;
            const uniqueGuests = new Set(allDocuments.map(doc => doc.guestEmail)).size;
            const totalSize = allDocuments.reduce((sum, doc) => sum + (doc.fileSize || 0), 0);
            
            document.getElementById('totalDocuments').textContent = totalDocuments;
            document.getElementById('guestsWithDocuments').textContent = uniqueGuests;
            document.getElementById('storageUsed').textContent = formatFileSize(totalSize);
        }

        function renderDocuments() {
            const documentsList = document.getElementById('documentsList');
            
            if (filteredDocuments.length === 0) {
                documentsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3>No Documents Found</h3>
                        <p>No documents match your current search criteria.</p>
                    </div>
                `;
                return;
            }
            
            documentsList.innerHTML = filteredDocuments.map(doc => `
                <div class="document-item">
                    <div class="document-icon">üìÑ</div>
                    <div class="document-info">
                        <div class="document-name">${doc.fileName || doc.originalFileName || 'Unknown File'}</div>
                        <div class="document-meta">
                            <span class="document-type-badge badge-${doc.documentType}">${formatDocumentType(doc.documentType)}</span>
                            <span>üë§ ${doc.guestEmail}</span>
                            <span>üìÖ ${formatDate(doc.uploadDate)}</span>
                            <span>üìè ${formatFileSize(doc.fileSize)}</span>
                        </div>
                    </div>
                    <div class="document-actions">
                        <button class="btn-view" onclick="viewDocument('${doc.downloadURL}', '${doc.fileName || doc.originalFileName || 'Unknown File'}')">
                            üëÅÔ∏è View
                        </button>
                        <button class="btn-delete" onclick="handleDeleteDocument('${doc.id}', 'documents/${doc.fileName || doc.originalFileName}', '${doc.fileName || doc.originalFileName || 'Unknown File'}')" id="deleteBtn-${doc.id}">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function formatDocumentType(type) {
            const types = {
                'id_proof': 'ID Proof',
                'college_id': 'College ID',
                'address_proof': 'Address Proof',
                'emergency_contact': 'Emergency Contact',
                'medical_certificate': 'Medical Certificate',
                'other': 'Other'
            };
            return types[type] || type;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function filterDocuments() {
            const searchTerm = document.getElementById('documentSearch').value.toLowerCase();
            const typeFilter = document.getElementById('documentTypeFilter').value;
            
            filteredDocuments = allDocuments.filter(doc => {
                const matchesSearch = !searchTerm || 
                    doc.fileName.toLowerCase().includes(searchTerm) ||
                    doc.guestEmail.toLowerCase().includes(searchTerm) ||
                    doc.documentType.toLowerCase().includes(searchTerm);
                
                const matchesType = !typeFilter || doc.documentType === typeFilter;
                
                return matchesSearch && matchesType;
            });
            
            renderDocuments();
        }

        function refreshDocuments() {
            loadAllDocuments();
        }

        function viewDocument(downloadURL, fileName) {
            // Open document in new tab
            window.open(downloadURL, '_blank');
        }

        // Global flag to prevent multiple delete operations
        let isDeleting = false;
        let currentDeleteId = null;

        async function handleDeleteDocument(documentId, storagePath, fileName) {
            // Prevent multiple simultaneous delete operations for the same document
            if (isDeleting && currentDeleteId === documentId) {
                return;
            }
            
            isDeleting = true;
            currentDeleteId = documentId;
            
            // Disable the delete button
            const deleteBtn = document.getElementById(`deleteBtn-${documentId}`);
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.textContent = '‚è≥ Deleting...';
            }
            
            try {
                // Extract filename from storagePath if fileName is undefined
                let displayName = fileName;
                if (!displayName && storagePath) {
                    displayName = storagePath.split('/').pop() || 'this document';
                }
                displayName = displayName || 'this document';
                
                if (!confirm(`Are you sure you want to delete "${displayName}"? This action cannot be undone.`)) {
                    return;
                }
            
                // Call the Firebase delete function
                await window.deleteDocument(documentId, storagePath);
                
                // Remove from local arrays
                allDocuments = allDocuments.filter(doc => doc.id !== documentId);
                filteredDocuments = filteredDocuments.filter(doc => doc.id !== documentId);
                
                // Update UI
                updateDocumentStats();
                renderDocuments();
                
                // Show success message
                showDocumentSuccess(`Document "${displayName}" deleted successfully.`);
                
            } catch (error) {
                console.error('Error deleting document:', error);
                showDocumentError('Failed to delete document. Please try again.');
            } finally {
                isDeleting = false;
                currentDeleteId = null;
                
                // Re-enable the delete button
                const deleteBtn = document.getElementById(`deleteBtn-${documentId}`);
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'üóëÔ∏è Delete';
                }
            }
        }

        function showDocumentSuccess(message) {
            // Create success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 600;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function showDocumentError(message) {
            // Create error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #dc3545, #c82333);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 600;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // Document Upload Functions
        function toggleUploadForm() {
            const uploadSection = document.querySelector('.document-upload-section');
            const uploadForm = document.getElementById('uploadForm');
            const toggleBtn = document.getElementById('toggleUploadBtn');
            
            if (uploadSection.style.display === 'none' || uploadSection.style.display === '') {
                // Show the upload section and form
                uploadSection.style.display = 'block';
                uploadForm.style.display = 'block';
                toggleBtn.textContent = '‚àí Hide Form';
                toggleBtn.classList.add('btn-secondary');
                toggleBtn.classList.remove('btn-primary');
            } else {
                // Hide the upload section and form
                uploadSection.style.display = 'none';
                uploadForm.style.display = 'none';
                toggleBtn.textContent = '+ Add Document';
                toggleBtn.classList.add('btn-primary');
                toggleBtn.classList.remove('btn-secondary');
                resetUploadForm();
            }
        }

        function resetUploadForm() {
            document.getElementById('guestEmail').value = '';
            document.getElementById('guestPhone').value = '';
            document.getElementById('documentType').value = '';
            document.getElementById('documentName').value = '';
            document.getElementById('documentFile').value = '';
            document.getElementById('documentNotes').value = '';
            
            // Hide file preview
            const previewSection = document.getElementById('filePreviewSection');
            if (previewSection) {
                previewSection.style.display = 'none';
            }
            
            // Reset preview container size
            const previewContainer = document.getElementById('filePreviewContainer');
            if (previewContainer) {
                previewContainer.style.width = 'auto';
                previewContainer.style.height = 'auto';
                previewContainer.style.minHeight = '200px';
            }
            
            // Hide crop controls and reset crop state
            const cropControls = document.getElementById('cropControls');
            if (cropControls) {
                cropControls.style.display = 'none';
            }
            
            // Hide occupant info section
            const occupantInfoSection = document.getElementById('occupantInfoSection');
            if (occupantInfoSection) {
                occupantInfoSection.style.display = 'none';
            }
            
            // Reset crop state
            cropMode = false;
            isDragging = false;
            currentImageElement = null;
            
            // Hide progress bar
            const progressDiv = document.getElementById('uploadProgress');
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
            
            // Reset upload button
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload Document';
            }
        }

        function previewFile() {
            const fileInput = document.getElementById('documentFile');
            const file = fileInput.files[0];
            const previewSection = document.getElementById('filePreviewSection');
            const previewContainer = document.getElementById('filePreviewContainer');
            const fileInfoPreview = document.getElementById('fileInfoPreview');
            
            if (!file) {
                previewSection.style.display = 'none';
                return;
            }
            
            // Show preview section
            previewSection.style.display = 'block';
            
            // Display file information
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            fileInfoPreview.innerHTML = `
                <div class="file-info-item">
                    <strong>File Name:</strong> ${file.name}
                </div>
                <div class="file-info-item">
                    <strong>File Size:</strong> ${fileSize} MB
                </div>
                <div class="file-info-item">
                    <strong>File Type:</strong> ${file.type}
                </div>
            `;
            
            // Clear previous preview
            previewContainer.innerHTML = '';
            
            if (file.type.startsWith('image/')) {
                // Image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'file-preview-image';
                    img.alt = 'Document Preview';
                    
                    // Wait for image to load to get dimensions
                    img.onload = function() {
                        // Calculate optimal size maintaining aspect ratio
                        const maxHeight = window.innerHeight * 0.5; // Half screen height
                        const maxWidth = previewContainer.parentElement.offsetWidth - 40; // Account for padding
                        
                        const aspectRatio = img.naturalWidth / img.naturalHeight;
                        
                        let displayWidth = img.naturalWidth;
                        let displayHeight = img.naturalHeight;
                        
                        // Scale down if too tall
                        if (displayHeight > maxHeight) {
                            displayHeight = maxHeight;
                            displayWidth = displayHeight * aspectRatio;
                        }
                        
                        // Scale down if too wide
                        if (displayWidth > maxWidth) {
                            displayWidth = maxWidth;
                            displayHeight = displayWidth / aspectRatio;
                        }
                        
                        // Set image dimensions
                        img.style.width = displayWidth + 'px';
                        img.style.height = displayHeight + 'px';
                        
                        // Resize container to fit image exactly
                        previewContainer.style.width = displayWidth + 'px';
                        previewContainer.style.height = displayHeight + 'px';
                        previewContainer.style.minHeight = 'auto';
                        
                        previewContainer.appendChild(img);
                        
                        // Store reference to current image element
                        currentImageElement = img;
                        
                        // Show crop controls for images
                        const cropControls = document.getElementById('cropControls');
                        cropControls.style.display = 'block';
                    };
                };
                reader.readAsDataURL(file);
                
            } else if (file.type === 'application/pdf') {
                // PDF preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const pdfPreview = document.createElement('div');
                    pdfPreview.className = 'file-preview-pdf';
                    pdfPreview.innerHTML = `
                        <div class="pdf-icon">üìÑ</div>
                        <div class="pdf-text">PDF Document</div>
                        <div class="pdf-filename">${file.name}</div>
                        <div class="pdf-note">Preview not available for PDF files</div>
                    `;
                    previewContainer.appendChild(pdfPreview);
                };
                reader.readAsDataURL(file);
                
                // Hide crop controls for PDFs
                const cropControls = document.getElementById('cropControls');
                cropControls.style.display = 'none';
                
            } else {
                // Unsupported file type
                previewContainer.innerHTML = `
                    <div class="file-preview-unsupported">
                        <div class="unsupported-icon">‚ùå</div>
                        <div class="unsupported-text">Unsupported file type</div>
                        <div class="unsupported-note">Please select a JPG, PNG, or PDF file</div>
                    </div>
                `;
                
                // Hide crop controls for unsupported files
                const cropControls = document.getElementById('cropControls');
                cropControls.style.display = 'none';
            }
        }

        // Function to lookup occupant information by phone number
        async function lookupOccupantInfo(phoneNumber) {
            try {
                // Normalize phone number
                let normalizedPhone = phoneNumber.replace(/\D/g, '');
                if (normalizedPhone.startsWith('91') && normalizedPhone.length === 12) {
                    normalizedPhone = normalizedPhone.substring(2);
                } else if (normalizedPhone.startsWith('91') && normalizedPhone.length === 13) {
                    normalizedPhone = normalizedPhone.substring(3);
                }
                
                // Query Firestore for occupant with this phone number
                const db = window.firebaseDB;
                const bedsRef = window.firestoreCollection(db, 'beds');
                const snapshot = await window.firestoreGetDocs(bedsRef);
                
                // Filter results by phone number
                let foundBed = null;
                let foundBedId = null;
                
                snapshot.forEach(doc => {
                    const bedData = doc.data();
                    if (bedData.occupantPhone === phoneNumber || bedData.occupantPhone === normalizedPhone) {
                        foundBed = bedData;
                        foundBedId = doc.id;
                    }
                });
                
                if (foundBed) {
                    // Show occupant information
                    showOccupantInfo(foundBed, foundBedId);
                } else {
                    console.log('No occupant found with phone number:', phoneNumber);
                }
            } catch (error) {
                console.error('Error looking up occupant:', error);
            }
        }

        function showOccupantInfo(bedData, bedId) {
            const occupantInfoSection = document.getElementById('occupantInfoSection');
            const occupantName = document.getElementById('occupantName');
            const occupantPhoneDisplay = document.getElementById('occupantPhoneDisplay');
            const occupantEmailDisplay = document.getElementById('occupantEmailDisplay');
            const occupantBedDisplay = document.getElementById('occupantBedDisplay');
            
            // Update occupant information
            if (occupantName) occupantName.textContent = bedData.occupantName || 'Not provided';
            if (occupantPhoneDisplay) occupantPhoneDisplay.textContent = bedData.occupantPhone || 'Not provided';
            if (occupantEmailDisplay) occupantEmailDisplay.textContent = bedData.occupantEmail || 'Not provided';
            if (occupantBedDisplay) occupantBedDisplay.textContent = `${bedData.room} - Bed ${bedData.bedNumber}`;
            
            // Show the occupant info section
            if (occupantInfoSection) occupantInfoSection.style.display = 'block';
            
            // Pre-fill the form fields
            const guestEmailField = document.getElementById('guestEmail');
            const guestPhoneField = document.getElementById('guestPhone');
            
            if (bedData.occupantEmail && guestEmailField) {
                guestEmailField.value = bedData.occupantEmail;
            }
            
            if (bedData.occupantPhone && guestPhoneField) {
                guestPhoneField.value = bedData.occupantPhone;
            }
        }

        // Crop functionality variables
        let cropMode = false;
        let cropStartX = 0;
        let cropStartY = 0;
        let cropEndX = 0;
        let cropEndY = 0;
        let isDragging = false;
        let originalImageData = null;
        let currentImageElement = null;

        function startCrop() {
            if (!currentImageElement) return;
            
            cropMode = true;
            document.getElementById('startCropBtn').style.display = 'none';
            document.getElementById('applyCropBtn').style.display = 'inline-block';
            document.getElementById('cancelCropBtn').style.display = 'inline-block';
            
            // Add crop overlay
            const previewContainer = document.getElementById('filePreviewContainer');
            const cropOverlay = document.createElement('div');
            cropOverlay.id = 'cropOverlay';
            cropOverlay.className = 'crop-overlay';
            
            // Set overlay styles to ensure it's positioned absolutely
            cropOverlay.style.position = 'absolute';
            cropOverlay.style.top = '0';
            cropOverlay.style.left = '0';
            cropOverlay.style.width = '100%';
            cropOverlay.style.height = '100%';
            cropOverlay.style.pointerEvents = 'none';
            cropOverlay.style.zIndex = '10';
            
            previewContainer.appendChild(cropOverlay);
            
            // Add event listeners for mouse events
            previewContainer.addEventListener('mousedown', handleCropMouseDown);
            previewContainer.addEventListener('mousemove', handleCropMouseMove);
            previewContainer.addEventListener('mouseup', handleCropMouseUp);
            
            // Prevent image dragging
            currentImageElement.style.pointerEvents = 'none';
            
            // Add cursor style
            previewContainer.style.cursor = 'crosshair';
        }

        function handleCropMouseDown(e) {
            if (!cropMode) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            isDragging = true;
            const rect = e.currentTarget.getBoundingClientRect();
            cropStartX = e.clientX - rect.left;
            cropStartY = e.clientY - rect.top;
            
            // Clear previous crop selection
            const cropOverlay = document.getElementById('cropOverlay');
            if (cropOverlay) {
                cropOverlay.innerHTML = '';
            }
        }

        function handleCropMouseMove(e) {
            if (!cropMode || !isDragging) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const rect = e.currentTarget.getBoundingClientRect();
            cropEndX = e.clientX - rect.left;
            cropEndY = e.clientY - rect.top;
            
            // Update crop selection visual
            updateCropSelection();
        }

        function handleCropMouseUp(e) {
            if (!cropMode || !isDragging) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            isDragging = false;
            const rect = e.currentTarget.getBoundingClientRect();
            cropEndX = e.clientX - rect.left;
            cropEndY = e.clientY - rect.top;
            
            
            // Finalize crop selection
            updateCropSelection();
        }

        function updateCropSelection() {
            const cropOverlay = document.getElementById('cropOverlay');
            if (!cropOverlay) return;
            
            const left = Math.min(cropStartX, cropEndX);
            const top = Math.min(cropStartY, cropEndY);
            const width = Math.abs(cropEndX - cropStartX);
            const height = Math.abs(cropEndY - cropStartY);
            
            // Get container dimensions
            const container = cropOverlay.parentElement;
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            
            // Ensure coordinates are within container bounds
            const clampedLeft = Math.max(0, Math.min(left, containerWidth));
            const clampedTop = Math.max(0, Math.min(top, containerHeight));
            const clampedWidth = Math.max(0, Math.min(width, containerWidth - clampedLeft));
            const clampedHeight = Math.max(0, Math.min(height, containerHeight - clampedTop));
            
            
            // Create dark overlay with transparent selection area
            cropOverlay.innerHTML = `
                <!-- Top dark area -->
                <div class="crop-dark-area" style="position: absolute; top: 0; left: 0; width: 100%; height: ${clampedTop}px; background: rgba(0, 0, 0, 0.5);"></div>
                
                <!-- Bottom dark area -->
                <div class="crop-dark-area" style="position: absolute; top: ${clampedTop + clampedHeight}px; left: 0; width: 100%; height: ${containerHeight - clampedTop - clampedHeight}px; background: rgba(0, 0, 0, 0.5);"></div>
                
                <!-- Left dark area -->
                <div class="crop-dark-area" style="position: absolute; top: ${clampedTop}px; left: 0; width: ${clampedLeft}px; height: ${clampedHeight}px; background: rgba(0, 0, 0, 0.5);"></div>
                
                <!-- Right dark area -->
                <div class="crop-dark-area" style="position: absolute; top: ${clampedTop}px; left: ${clampedLeft + clampedWidth}px; width: ${containerWidth - clampedLeft - clampedWidth}px; height: ${clampedHeight}px; background: rgba(0, 0, 0, 0.5);"></div>
                
                <!-- Selection border -->
                <div class="crop-selection" style="left: ${clampedLeft}px; top: ${clampedTop}px; width: ${clampedWidth}px; height: ${clampedHeight}px;"></div>
            `;
        }

        function applyCrop() {
            if (!currentImageElement || !cropMode) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Get image dimensions
            const img = currentImageElement;
            const imgRect = img.getBoundingClientRect();
            const containerRect = document.getElementById('filePreviewContainer').getBoundingClientRect();
            
            // Calculate scale factors
            const scaleX = img.naturalWidth / imgRect.width;
            const scaleY = img.naturalHeight / imgRect.height;
            
            // Calculate crop coordinates relative to image
            const cropLeft = Math.min(cropStartX, cropEndX) - (imgRect.left - containerRect.left);
            const cropTop = Math.min(cropStartY, cropEndY) - (imgRect.top - containerRect.top);
            const cropWidth = Math.abs(cropEndX - cropStartX);
            const cropHeight = Math.abs(cropEndY - cropStartY);
            
            // Set canvas size to crop dimensions
            canvas.width = cropWidth * scaleX;
            canvas.height = cropHeight * scaleY;
            
            // Draw cropped image
            ctx.drawImage(
                img,
                cropLeft * scaleX, cropTop * scaleY, cropWidth * scaleX, cropHeight * scaleY,
                0, 0, cropWidth * scaleX, cropHeight * scaleY
            );
            
            // Get file input reference
            const fileInput = document.getElementById('documentFile');
            
            // Convert canvas to blob and update file input
            canvas.toBlob(function(blob) {
                // Create new file from cropped image
                const croppedFile = new File([blob], fileInput.files[0].name, {
                    type: fileInput.files[0].type,
                    lastModified: Date.now()
                });
                
                // Create new FileList
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(croppedFile);
                fileInput.files = dataTransfer.files;
                
                // Update preview with cropped image
                const croppedImg = document.createElement('img');
                croppedImg.src = URL.createObjectURL(blob);
                croppedImg.className = 'file-preview-image';
                croppedImg.alt = 'Cropped Document Preview';
                
                const previewContainer = document.getElementById('filePreviewContainer');
                previewContainer.innerHTML = '';
                previewContainer.appendChild(croppedImg);
                
                // Update current image element
                currentImageElement = croppedImg;
                
                // Clean up
                cancelCrop();
            }, fileInput.files[0].type, 0.9);
        }

        function cancelCrop() {
            cropMode = false;
            isDragging = false;
            
            // Reset buttons
            document.getElementById('startCropBtn').style.display = 'inline-block';
            document.getElementById('applyCropBtn').style.display = 'none';
            document.getElementById('cancelCropBtn').style.display = 'none';
            
            // Remove crop overlay
            const cropOverlay = document.getElementById('cropOverlay');
            if (cropOverlay) {
                cropOverlay.remove();
            }
            
            // Remove event listeners
            const previewContainer = document.getElementById('filePreviewContainer');
            previewContainer.removeEventListener('mousedown', handleCropMouseDown);
            previewContainer.removeEventListener('mousemove', handleCropMouseMove);
            previewContainer.removeEventListener('mouseup', handleCropMouseUp);
            
            // Restore image interaction and cursor
            if (currentImageElement) {
                currentImageElement.style.pointerEvents = 'auto';
            }
            previewContainer.style.cursor = 'default';
        }

        async function uploadDocument() {
            const guestEmail = document.getElementById('guestEmail').value.trim();
            const guestPhone = document.getElementById('guestPhone').value.trim();
            const documentType = document.getElementById('documentType').value;
            const documentName = document.getElementById('documentName').value.trim();
            const documentFile = document.getElementById('documentFile').files[0];
            const documentNotes = document.getElementById('documentNotes').value.trim();
            
            // Validation
            if (!guestPhone || !documentType || !documentFile) {
                alert('Please fill in mobile number, document type, and select a file.');
                return;
            }
            
            // Prevent duplicate uploads
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn.disabled) {
                console.log('Upload already in progress, ignoring duplicate request');
                return;
            }
            
            // Mobile number validation and normalization
            let normalizedPhone = guestPhone.replace(/\D/g, ''); // Remove all non-digits
            
            // Handle +91 country code
            if (normalizedPhone.startsWith('91') && normalizedPhone.length === 12) {
                // Remove +91 country code, keep 10 digits
                normalizedPhone = normalizedPhone.substring(2);
            } else if (normalizedPhone.startsWith('91') && normalizedPhone.length === 13) {
                // Handle +91 with extra digit, keep last 10 digits
                normalizedPhone = normalizedPhone.substring(3);
            }
            
            // Validate Indian mobile number (10 digits, starting with 6-9)
            if (normalizedPhone.length !== 10 || !/^[6-9]/.test(normalizedPhone)) {
                alert('Please enter a valid Indian mobile number (10 digits starting with 6-9).');
                return;
            }
            
            // File size validation (10MB limit)
            if (documentFile.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB.');
                return;
            }
            
            // File type validation
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(documentFile.type)) {
                alert('Please select a valid file type (JPG, PNG, or PDF).');
                return;
            }
            
            try {
                // Show progress bar
                const progressDiv = document.getElementById('uploadProgress');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const uploadBtn = document.getElementById('uploadBtn');
                
                progressDiv.style.display = 'block';
                uploadBtn.disabled = true;
                uploadBtn.textContent = '‚è≥ Uploading...';
                
                // Update progress
                progressFill.style.width = '20%';
                progressText.textContent = 'Preparing file...';
                
                // Generate filename using mobile number and document name
                const timestamp = Date.now();
                const fileExtension = documentFile.name.split('.').pop();
                const cleanDocumentName = (documentName || documentType.replace('_', ' ')).replace(/[^a-zA-Z0-9]/g, '_');
                const fileName = `${normalizedPhone}_${cleanDocumentName}_${timestamp}.${fileExtension}`;
                
                // Create Firebase Storage reference
                const storage = window.firebaseStorage;
                const storageRef = window.storageRef(storage);
                const documentRef = window.storageRef(storage, `documents/${fileName}`);
                
                // Update progress
                progressFill.style.width = '40%';
                progressText.textContent = 'Uploading to Firebase Storage...';
                
                // Upload file to Firebase Storage
                const uploadTask = window.storageUploadBytesResumable(documentRef, documentFile);
                
                // Monitor upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = `${40 + (progress * 0.4)}%`;
                        progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        alert('Upload failed: ' + error.message);
                        resetUploadForm();
                    },
                    async () => {
                        try {
                            // Get download URL
                            progressFill.style.width = '80%';
                            progressText.textContent = 'Getting download URL...';
                            
                            const downloadURL = await window.storageGetDownloadURL(documentRef);
                            
                            // Update progress
                            progressFill.style.width = '90%';
                            progressText.textContent = 'Saving document information...';
                            
                            // Save document metadata to Firestore
                            const db = window.firebaseDB;
                            const documentsRef = window.firestoreCollection(db, 'guest-documents');
                            const documentData = {
                                guestEmail: guestEmail || null,
                                guestPhone: guestPhone, // Original phone number as entered
                                guestPhoneNormalized: normalizedPhone, // Normalized 10-digit number
                                documentType: documentType,
                                documentName: documentName || `${documentType.replace('_', ' ').toUpperCase()}`,
                                fileName: fileName,
                                originalFileName: documentFile.name,
                                downloadURL: downloadURL,
                                fileSize: documentFile.size,
                                fileType: documentFile.type,
                                notes: documentNotes,
                                uploadDate: new Date(),
                                uploadedBy: window.firebaseAuth.currentUser.email
                            };
                            
                            const newDocRef = window.firestoreDoc(documentsRef);
                            await window.firestoreSetDoc(newDocRef, documentData);
                            
                            // Complete progress
                            progressFill.style.width = '100%';
                            progressText.textContent = 'Upload completed successfully!';
                            
                            // Show success message
                            setTimeout(async () => {
                                alert('Document uploaded successfully!');
                                resetUploadForm();
                                toggleUploadForm();
                                
                                // Refresh documents list
                                await loadAllDocuments();
                            }, 1000);
                            
                        } catch (error) {
                            console.error('Error saving document metadata:', error);
                            alert('Document uploaded but failed to save metadata: ' + error.message);
                            resetUploadForm();
                        }
                    }
                );
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
                resetUploadForm();
            }
        }
    </script>
</body>
</html>
