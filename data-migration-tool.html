<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Migration Tool - Room Swap</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e293b;
            text-align: center;
            margin-bottom: 30px;
        }
        .warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .warning h3 {
            color: #92400e;
            margin-top: 0;
        }
        .info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .info h3 {
            color: #1e40af;
            margin-top: 0;
        }
        .step {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
        }
        .step h4 {
            margin-top: 0;
            color: #1e293b;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .danger {
            background: #dc2626;
        }
        .danger:hover {
            background: #b91c1c;
        }
        .success {
            background: #059669;
        }
        .success:hover {
            background: #047857;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status.pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status.running {
            background: #dbeafe;
            color: #1e40af;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Room Data Migration Tool</h1>
        
        <div class="warning">
            <h3>‚ö†Ô∏è CRITICAL WARNING</h3>
            <p><strong>This operation will permanently swap ALL data between Room 1 and Room 3 in Firestore.</strong></p>
            <ul>
                <li>All occupant information will be moved</li>
                <li>All bed assignments will be swapped</li>
                <li>All transaction history will be updated</li>
                <li>All AC bills will be reassigned</li>
                <li>All documents will be relinked</li>
            </ul>
            <p><strong>This operation cannot be undone!</strong></p>
        </div>

        <div class="info">
            <h3>üìã What This Tool Will Do:</h3>
            <div class="step">
                <h4>Step 1: Backup Current Data</h4>
                <p>Create a backup of all current room data before making changes</p>
            </div>
            <div class="step">
                <h4>Step 2: Swap Bed Data</h4>
                <p>Update all bed documents to swap room1 ‚Üî room3 assignments</p>
            </div>
            <div class="step">
                <h4>Step 3: Update Transactions</h4>
                <p>Update all transaction records to reflect new room assignments</p>
            </div>
            <div class="step">
                <h4>Step 4: Update AC Bills</h4>
                <p>Update all AC bill records to reflect new room assignments</p>
            </div>
            <div class="step">
                <h4>Step 5: Update Documents</h4>
                <p>Update all document records to reflect new room assignments</p>
            </div>
        </div>

        <div id="status" class="status pending">
            Ready to start migration. Click "Start Migration" to begin.
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button id="startBtn" onclick="startMigration()">üöÄ Start Migration</button>
            <button id="backupBtn" onclick="createBackup()" style="background: #059669;">üíæ Create Backup Only</button>
            <button id="restoreBtn" onclick="restoreFromBackup()" style="background: #7c3aed;">üîÑ Restore from Backup</button>
            <button id="testBtn" onclick="testConnection()" style="background: #f59e0b;">üîç Test Connection</button>
            <button id="fixBtn" onclick="fixMixedState()" style="background: #dc2626;">üîß Fix Mixed State</button>
            <button id="emergencyBtn" onclick="emergencyRecovery()" style="background: #ef4444; color: white;">üö® Emergency Recovery</button>
        </div>

        <div id="log" class="log" style="display: none;"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, setDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration (matching main application)
        const firebaseConfig = {
            apiKey: "AIzaSyCvIaT8x5lKq6yA5YW8OUyn_uC_uJLeuZE",
            authDomain: "comfort-stays.firebaseapp.com",
            projectId: "comfort-stays",
            storageBucket: "comfort-stays.firebasestorage.app",
            messagingSenderId: "187885851533",
            appId: "1:187885851533:web:5f82713f2ddd8fe889e3c4",
            measurementId: "G-KYZ4HX31C9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let migrationLog = [];
        let backupData = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            migrationLog.push(logMessage);
            console.log(logMessage);
            
            const logElement = document.getElementById('log');
            logElement.style.display = 'block';
            logElement.textContent = migrationLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message, type = 'running') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        async function createBackup() {
            try {
                updateStatus('Creating backup...', 'running');
                log('Starting backup creation...');
                
                const collections = ['beds', 'transactions', 'ac-bills', 'guest-documents'];
                backupData = {};
                
                for (const collectionName of collections) {
                    log(`Backing up ${collectionName} collection...`);
                    const snapshot = await getDocs(collection(db, collectionName));
                    backupData[collectionName] = [];
                    
                    snapshot.forEach(doc => {
                        backupData[collectionName].push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });
                    
                    log(`Backed up ${backupData[collectionName].length} documents from ${collectionName}`);
                }
                
                // Save backup to localStorage
                localStorage.setItem('roomSwapBackup', JSON.stringify(backupData));
                log('Backup saved to localStorage');
                
                updateStatus('Backup created successfully!', 'success');
                log('Backup creation completed successfully!');
                
            } catch (error) {
                log(`Error creating backup: ${error.message}`);
                updateStatus('Backup failed!', 'error');
            }
        }

        async function restoreFromBackup() {
            try {
                const backup = localStorage.getItem('roomSwapBackup');
                if (!backup) {
                    alert('No backup found in localStorage!');
                    return;
                }
                
                if (!confirm('Are you sure you want to restore from backup? This will overwrite all current data!')) {
                    return;
                }
                
                updateStatus('Restoring from backup...', 'running');
                log('Starting restore from backup...');
                
                backupData = JSON.parse(backup);
                
                for (const [collectionName, documents] of Object.entries(backupData)) {
                    log(`Restoring ${collectionName} collection...`);
                    
                    for (const docData of documents) {
                        await setDoc(doc(db, collectionName, docData.id), docData.data);
                    }
                    
                    log(`Restored ${documents.length} documents to ${collectionName}`);
                }
                
                updateStatus('Restore completed successfully!', 'success');
                log('Restore completed successfully!');
                
            } catch (error) {
                log(`Error restoring from backup: ${error.message}`);
                updateStatus('Restore failed!', 'error');
            }
        }

        async function startMigration() {
            if (!confirm('Are you sure you want to start the migration? This will permanently swap Room 1 and Room 3 data!')) {
                return;
            }
            
            try {
                updateStatus('Migration in progress...', 'running');
                log('Starting Room 1 ‚Üî Room 3 data migration...');
                
                // Step 1: Create backup
                log('Step 1: Creating backup...');
                await createBackup();
                
                // Step 2: Swap bed data
                log('Step 2: Swapping bed data...');
                await swapBedData();
                
                // Step 3: Update transactions
                log('Step 3: Updating transactions...');
                await updateTransactions();
                
                // Step 4: Update AC bills
                log('Step 4: Updating AC bills...');
                await updateACBills();
                
                // Step 5: Update documents
                log('Step 5: Updating documents...');
                await updateDocuments();
                
                updateStatus('Migration completed successfully!', 'success');
                log('üéâ Migration completed successfully! All data has been swapped between Room 1 and Room 3.');
                
            } catch (error) {
                log(`Migration failed: ${error.message}`);
                updateStatus('Migration failed!', 'error');
            }
        }

        async function swapBedData() {
            log('Starting bed data swap...');
            const bedsSnapshot = await getDocs(collection(db, 'beds'));
            log(`Found ${bedsSnapshot.docs.length} bed documents`);
            
            let updatedCount = 0;
            
            // First, collect all bed data
            const bedDataToSwap = [];
            
            for (const bedDoc of bedsSnapshot.docs) {
                const bedData = bedDoc.data();
                log(`Processing bed ${bedDoc.id}: room=${bedData.room}, occupant=${bedData.occupantName || 'Available'}`);
                
                if (bedData.room === 'room1' || bedData.room === 'room3') {
                    bedDataToSwap.push({
                        oldId: bedDoc.id,
                        oldRoom: bedData.room,
                        data: bedData
                    });
                }
            }
            
            // Now swap the documents
            for (const bedInfo of bedDataToSwap) {
                let newId, newRoom;
                
                if (bedInfo.oldRoom === 'room1') {
                    newRoom = 'room3';
                    newId = bedInfo.oldId.replace('room1_', 'room3_');
                } else if (bedInfo.oldRoom === 'room3') {
                    newRoom = 'room1';
                    newId = bedInfo.oldId.replace('room3_', 'room1_');
                }
                
                // Create new document with swapped ID and room
                const newData = {
                    ...bedInfo.data,
                    room: newRoom
                };
                
                await setDoc(doc(db, 'beds', newId), newData);
                log(`Created new bed ${newId}: ${bedInfo.oldRoom} ‚Üí ${newRoom}`);
                
                // Delete old document
                await deleteDoc(doc(db, 'beds', bedInfo.oldId));
                log(`Deleted old bed ${bedInfo.oldId}`);
                
                updatedCount++;
            }
            
            log(`Swapped ${updatedCount} bed records`);
        }

        async function updateTransactions() {
            log('Starting transaction updates...');
            const transactionsSnapshot = await getDocs(collection(db, 'transactions'));
            log(`Found ${transactionsSnapshot.docs.length} transaction documents`);
            
            let updatedCount = 0;
            
            for (const transactionDoc of transactionsSnapshot.docs) {
                const transactionData = transactionDoc.data();
                log(`Processing transaction ${transactionDoc.id}: bedId=${transactionData.bedId}, type=${transactionData.type}`);
                
                if (transactionData.bedId) {
                    let newBedId = transactionData.bedId;
                    
                    if (transactionData.bedId.startsWith('room1_')) {
                        newBedId = transactionData.bedId.replace('room1_', 'room3_');
                    } else if (transactionData.bedId.startsWith('room3_')) {
                        newBedId = transactionData.bedId.replace('room3_', 'room1_');
                    }
                    
                    if (newBedId !== transactionData.bedId) {
                        await updateDoc(doc(db, 'transactions', transactionDoc.id), {
                            bedId: newBedId
                        });
                        log(`Updated transaction ${transactionDoc.id}: ${transactionData.bedId} ‚Üí ${newBedId}`);
                        updatedCount++;
                    } else {
                        log(`Skipping transaction ${transactionDoc.id}: bedId=${transactionData.bedId} (no room1/room3)`);
                    }
                } else {
                    log(`Skipping transaction ${transactionDoc.id}: no bedId`);
                }
            }
            
            log(`Updated ${updatedCount} transaction records`);
        }

        async function updateACBills() {
            const acBillsSnapshot = await getDocs(collection(db, 'ac-bills'));
            let updatedCount = 0;
            
            for (const acBillDoc of acBillsSnapshot.docs) {
                const acBillData = acBillDoc.data();
                
                if (acBillData.roomId === 'room1') {
                    await updateDoc(doc(db, 'ac-bills', acBillDoc.id), {
                        roomId: 'room3',
                        roomName: 'Room 3 (Top)'
                    });
                    log(`Updated AC bill ${acBillDoc.id}: room1 ‚Üí room3`);
                    updatedCount++;
                } else if (acBillData.roomId === 'room3') {
                    await updateDoc(doc(db, 'ac-bills', acBillDoc.id), {
                        roomId: 'room1',
                        roomName: 'Room 1 (Bottom)'
                    });
                    log(`Updated AC bill ${acBillDoc.id}: room3 ‚Üí room1`);
                    updatedCount++;
                }
                
                // Update bedId in AC bills
                if (acBillData.bedId) {
                    let newBedId = acBillData.bedId;
                    
                    if (acBillData.bedId.startsWith('room1_')) {
                        newBedId = acBillData.bedId.replace('room1_', 'room3_');
                    } else if (acBillData.bedId.startsWith('room3_')) {
                        newBedId = acBillData.bedId.replace('room3_', 'room1_');
                    }
                    
                    if (newBedId !== acBillData.bedId) {
                        await updateDoc(doc(db, 'ac-bills', acBillDoc.id), {
                            bedId: newBedId
                        });
                        log(`Updated AC bill bedId ${acBillDoc.id}: ${acBillData.bedId} ‚Üí ${newBedId}`);
                    }
                }
            }
            
            log(`Updated ${updatedCount} AC bill records`);
        }

        async function updateDocuments() {
            const documentsSnapshot = await getDocs(collection(db, 'guest-documents'));
            let updatedCount = 0;
            
            for (const documentDoc of documentsSnapshot.docs) {
                const documentData = documentDoc.data();
                
                if (documentData.bedId) {
                    let newBedId = documentData.bedId;
                    
                    if (documentData.bedId.startsWith('room1_')) {
                        newBedId = documentData.bedId.replace('room1_', 'room3_');
                    } else if (documentData.bedId.startsWith('room3_')) {
                        newBedId = documentData.bedId.replace('room3_', 'room1_');
                    }
                    
                    if (newBedId !== documentData.bedId) {
                        await updateDoc(doc(db, 'guest-documents', documentDoc.id), {
                            bedId: newBedId
                        });
                        log(`Updated document ${documentDoc.id}: ${documentData.bedId} ‚Üí ${newBedId}`);
                        updatedCount++;
                    }
                }
            }
            
            log(`Updated ${updatedCount} document records`);
        }

        async function testConnection() {
            try {
                updateStatus('Testing Firebase connection...', 'running');
                log('Testing Firebase connection...');
                
                const collections = ['beds', 'transactions', 'ac-bills', 'guest-documents'];
                
                for (const collectionName of collections) {
                    try {
                        log(`Testing ${collectionName} collection...`);
                        const snapshot = await getDocs(collection(db, collectionName));
                        log(`‚úÖ ${collectionName}: Found ${snapshot.docs.length} documents`);
                        
                        // Show first few documents as examples
                        if (snapshot.docs.length > 0) {
                            const firstDoc = snapshot.docs[0];
                            const data = firstDoc.data();
                            log(`   Example document ${firstDoc.id}: ${JSON.stringify(data, null, 2)}`);
                        }
                        
                    } catch (error) {
                        log(`‚ùå ${collectionName}: Error - ${error.message}`);
                    }
                }
                
                updateStatus('Connection test completed!', 'success');
                log('Connection test completed!');
                
            } catch (error) {
                log(`Connection test failed: ${error.message}`);
                updateStatus('Connection test failed!', 'error');
            }
        }

        async function fixMixedState() {
            try {
                updateStatus('Fixing mixed state...', 'running');
                log('Starting mixed state fix...');
                
                // First, let's analyze the current state
                log('Analyzing current bed data state...');
                const bedsSnapshot = await getDocs(collection(db, 'beds'));
                
                const problematicBeds = [];
                const correctBeds = [];
                
                for (const bedDoc of bedsSnapshot.docs) {
                    const bedData = bedDoc.data();
                    const docIdRoom = bedDoc.id.split('_')[0]; // Extract room from document ID
                    const dataRoom = bedData.room; // Room from data field
                    
                    log(`Bed ${bedDoc.id}: docId suggests ${docIdRoom}, data says ${dataRoom}`);
                    
                    if (docIdRoom !== dataRoom) {
                        problematicBeds.push({
                            docId: bedDoc.id,
                            docIdRoom: docIdRoom,
                            dataRoom: dataRoom,
                            data: bedData
                        });
                    } else {
                        correctBeds.push({
                            docId: bedDoc.id,
                            room: dataRoom,
                            data: bedData
                        });
                    }
                }
                
                log(`Found ${problematicBeds.length} problematic beds and ${correctBeds.length} correct beds`);
                
                if (problematicBeds.length === 0) {
                    log('No mixed state detected. All beds are correctly aligned.');
                    updateStatus('No fix needed!', 'success');
                    return;
                }
                
                // Fix the problematic beds
                log('Fixing problematic beds...');
                let fixedCount = 0;
                
                for (const bed of problematicBeds) {
                    // Create correct document ID
                    const correctDocId = bed.docId.replace(bed.docIdRoom, bed.dataRoom);
                    
                    // Create new document with correct ID and room field
                    const correctData = {
                        ...bed.data,
                        room: bed.dataRoom
                    };
                    
                    await setDoc(doc(db, 'beds', correctDocId), correctData);
                    log(`Created correct bed ${correctDocId} with room ${bed.dataRoom}`);
                    
                    // Delete the problematic document
                    await deleteDoc(doc(db, 'beds', bed.docId));
                    log(`Deleted problematic bed ${bed.docId}`);
                    
                    fixedCount++;
                }
                
                // Update all references in other collections
                log('Updating references in transactions...');
                await updateTransactionReferences();
                
                log('Updating references in AC bills...');
                await updateACBillReferences();
                
                log('Updating references in documents...');
                await updateDocumentReferences();
                
                log(`Fixed ${fixedCount} beds and updated all references`);
                updateStatus('Mixed state fixed successfully!', 'success');
                
            } catch (error) {
                log(`Fix failed: ${error.message}`);
                updateStatus('Fix failed!', 'error');
            }
        }

        async function updateTransactionReferences() {
            const transactionsSnapshot = await getDocs(collection(db, 'transactions'));
            let updatedCount = 0;
            
            for (const transactionDoc of transactionsSnapshot.docs) {
                const transactionData = transactionDoc.data();
                
                if (transactionData.bedId) {
                    let newBedId = transactionData.bedId;
                    let needsUpdate = false;
                    
                    // Check if bedId needs to be corrected
                    if (transactionData.bedId.startsWith('room1_') && transactionData.bedId.includes('room3')) {
                        newBedId = transactionData.bedId.replace('room1_', 'room3_');
                        needsUpdate = true;
                    } else if (transactionData.bedId.startsWith('room3_') && transactionData.bedId.includes('room1')) {
                        newBedId = transactionData.bedId.replace('room3_', 'room1_');
                        needsUpdate = true;
                    }
                    
                    if (needsUpdate) {
                        await updateDoc(doc(db, 'transactions', transactionDoc.id), {
                            bedId: newBedId
                        });
                        log(`Updated transaction ${transactionDoc.id}: ${transactionData.bedId} ‚Üí ${newBedId}`);
                        updatedCount++;
                    }
                }
            }
            
            log(`Updated ${updatedCount} transaction references`);
        }

        async function updateACBillReferences() {
            const acBillsSnapshot = await getDocs(collection(db, 'ac-bills'));
            let updatedCount = 0;
            
            for (const acBillDoc of acBillsSnapshot.docs) {
                const acBillData = acBillDoc.data();
                
                if (acBillData.bedId) {
                    let newBedId = acBillData.bedId;
                    let needsUpdate = false;
                    
                    if (acBillData.bedId.startsWith('room1_') && acBillData.bedId.includes('room3')) {
                        newBedId = acBillData.bedId.replace('room1_', 'room3_');
                        needsUpdate = true;
                    } else if (acBillData.bedId.startsWith('room3_') && acBillData.bedId.includes('room1')) {
                        newBedId = acBillData.bedId.replace('room3_', 'room1_');
                        needsUpdate = true;
                    }
                    
                    if (needsUpdate) {
                        await updateDoc(doc(db, 'ac-bills', acBillDoc.id), {
                            bedId: newBedId
                        });
                        log(`Updated AC bill ${acBillDoc.id}: ${acBillData.bedId} ‚Üí ${newBedId}`);
                        updatedCount++;
                    }
                }
            }
            
            log(`Updated ${updatedCount} AC bill references`);
        }

        async function updateDocumentReferences() {
            const documentsSnapshot = await getDocs(collection(db, 'guest-documents'));
            let updatedCount = 0;
            
            for (const documentDoc of documentsSnapshot.docs) {
                const documentData = documentDoc.data();
                
                if (documentData.bedId) {
                    let newBedId = documentData.bedId;
                    let needsUpdate = false;
                    
                    if (documentData.bedId.startsWith('room1_') && documentData.bedId.includes('room3')) {
                        newBedId = documentData.bedId.replace('room1_', 'room3_');
                        needsUpdate = true;
                    } else if (documentData.bedId.startsWith('room3_') && documentData.bedId.includes('room1')) {
                        newBedId = documentData.bedId.replace('room3_', 'room1_');
                        needsUpdate = true;
                    }
                    
                    if (needsUpdate) {
                        await updateDoc(doc(db, 'guest-documents', documentDoc.id), {
                            bedId: newBedId
                        });
                        log(`Updated document ${documentDoc.id}: ${documentData.bedId} ‚Üí ${newBedId}`);
                        updatedCount++;
                    }
                }
            }
            
            log(`Updated ${updatedCount} document references`);
        }

        async function emergencyRecovery() {
            try {
                updateStatus('üö® EMERGENCY RECOVERY - Analyzing data loss...', 'running');
                log('üö® EMERGENCY RECOVERY STARTED');
                log('Analyzing current bed data to identify missing room3 data...');
                
                const bedsSnapshot = await getDocs(collection(db, 'beds'));
                log(`Found ${bedsSnapshot.docs.length} bed documents`);
                
                const room1Beds = [];
                const room3Beds = [];
                const otherBeds = [];
                
                for (const bedDoc of bedsSnapshot.docs) {
                    const bedData = bedDoc.data();
                    const docId = bedDoc.id;
                    
                    log(`Bed ${docId}: room=${bedData.room}, occupant=${bedData.occupantName || 'Available'}`);
                    
                    if (docId.startsWith('room1_')) {
                        room1Beds.push({ id: docId, data: bedData });
                    } else if (docId.startsWith('room3_')) {
                        room3Beds.push({ id: docId, data: bedData });
                    } else {
                        otherBeds.push({ id: docId, data: bedData });
                    }
                }
                
                log(`Room 1 beds: ${room1Beds.length}`);
                log(`Room 3 beds: ${room3Beds.length}`);
                log(`Other beds: ${otherBeds.length}`);
                
                // Check if room3 data is missing
                if (room3Beds.length === 0) {
                    log('üö® CRITICAL: No room3 beds found!');
                    
                    // Check if room1 has room3 data (mixed state)
                    const room1WithRoom3Data = room1Beds.filter(bed => bed.data.room === 'room3');
                    
                    if (room1WithRoom3Data.length > 0) {
                        log(`Found ${room1WithRoom3Data.length} room1 documents with room3 data - attempting recovery...`);
                        
                        // Recover room3 data from room1 documents
                        let recoveredCount = 0;
                        
                        for (const bed of room1WithRoom3Data) {
                            // Create proper room3 document
                            const room3Id = bed.id.replace('room1_', 'room3_');
                            const room3Data = {
                                ...bed.data,
                                room: 'room3'
                            };
                            
                            await setDoc(doc(db, 'beds', room3Id), room3Data);
                            log(`‚úÖ Recovered room3 bed: ${room3Id}`);
                            
                            // Delete the mixed room1 document
                            await deleteDoc(doc(db, 'beds', bed.id));
                            log(`üóëÔ∏è Deleted mixed room1 document: ${bed.id}`);
                            
                            recoveredCount++;
                        }
                        
                        log(`‚úÖ SUCCESS: Recovered ${recoveredCount} room3 beds!`);
                        
                        // Update all references
                        log('Updating references in transactions...');
                        await updateAllReferences();
                        
                        updateStatus('‚úÖ Room 3 data recovered successfully!', 'success');
                        
                    } else {
                        log('‚ùå No room3 data found in room1 documents either!');
                        log('üîç Checking if room3 data exists in other collections...');
                        
                        // Check transactions for room3 references
                        const transactionsSnapshot = await getDocs(collection(db, 'transactions'));
                        const room3Transactions = [];
                        
                        for (const transactionDoc of transactionsSnapshot.docs) {
                            const transactionData = transactionDoc.data();
                            if (transactionData.bedId && transactionData.bedId.startsWith('room3_')) {
                                room3Transactions.push(transactionData);
                            }
                        }
                        
                        log(`Found ${room3Transactions.length} transactions referencing room3 beds`);
                        
                        if (room3Transactions.length > 0) {
                            log('üîç Room3 data exists in transactions - attempting to recreate bed documents...');
                            
                            // Try to recreate room3 beds from transaction data
                            const room3BedNumbers = new Set();
                            for (const transaction of room3Transactions) {
                                const bedNumber = transaction.bedId.split('_')[1];
                                room3BedNumbers.add(bedNumber);
                            }
                            
                            log(`Found room3 bed numbers: ${Array.from(room3BedNumbers).join(', ')}`);
                            
                            // Create empty room3 bed documents
                            for (const bedNumber of room3BedNumbers) {
                                const room3Id = `room3_${bedNumber}`;
                                const room3Data = {
                                    room: 'room3',
                                    bedNumber: parseInt(bedNumber.replace('bed', '')),
                                    occupantName: null,
                                    occupantPhone: null,
                                    occupantEmail: null,
                                    checkInDate: null,
                                    checkOutDate: null,
                                    price: 6500,
                                    status: 'available'
                                };
                                
                                await setDoc(doc(db, 'beds', room3Id), room3Data);
                                log(`‚úÖ Created empty room3 bed: ${room3Id}`);
                            }
                            
                            updateStatus('‚úÖ Room 3 beds recreated from transaction data!', 'success');
                            
                        } else {
                            log('‚ùå No room3 references found anywhere!');
                            log('üí° Suggestion: Check if you have a backup or if data was deleted elsewhere');
                            updateStatus('‚ùå No room3 data found to recover', 'error');
                        }
                    }
                    
                } else {
                    log('‚úÖ Room3 beds exist - no recovery needed');
                    updateStatus('‚úÖ Room 3 data is intact', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Emergency recovery failed: ${error.message}`);
                updateStatus('‚ùå Emergency recovery failed!', 'error');
            }
        }

        async function updateAllReferences() {
            // Update transaction references
            const transactionsSnapshot = await getDocs(collection(db, 'transactions'));
            let updatedTransactions = 0;
            
            for (const transactionDoc of transactionsSnapshot.docs) {
                const transactionData = transactionDoc.data();
                
                if (transactionData.bedId) {
                    let newBedId = transactionData.bedId;
                    let needsUpdate = false;
                    
                    // Fix any mixed references
                    if (transactionData.bedId.startsWith('room1_') && transactionData.bedId.includes('room3')) {
                        newBedId = transactionData.bedId.replace('room1_', 'room3_');
                        needsUpdate = true;
                    } else if (transactionData.bedId.startsWith('room3_') && transactionData.bedId.includes('room1')) {
                        newBedId = transactionData.bedId.replace('room3_', 'room1_');
                        needsUpdate = true;
                    }
                    
                    if (needsUpdate) {
                        await updateDoc(doc(db, 'transactions', transactionDoc.id), {
                            bedId: newBedId
                        });
                        log(`Updated transaction ${transactionDoc.id}: ${transactionData.bedId} ‚Üí ${newBedId}`);
                        updatedTransactions++;
                    }
                }
            }
            
            log(`Updated ${updatedTransactions} transaction references`);
        }

        // Make functions globally available
        window.startMigration = startMigration;
        window.createBackup = createBackup;
        window.restoreFromBackup = restoreFromBackup;
        window.testConnection = testConnection;
        window.fixMixedState = fixMixedState;
        window.emergencyRecovery = emergencyRecovery;
    </script>
</body>
</html>
